{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- Heading -->
<div class="d-flex align-items-center justify-content-between text-white mt-4 px-4 py-3 mb-4 rounded shadow"
     style="background-color: #2A2F5B;">
  <h3 class="mb-0 letter-spacing-1 text-white">
    <i class="fa fa-users me-2"></i>&nbsp;Voter List
  </h3>
  <a href="{% url 'voters' %}" id="addVoterBtn"
     class="btn btn-lg btn-warning text-dark fw-semibold shadow-sm d-flex align-items-center">
    <i class="fa-solid fa-circle-plus me-2"></i>&nbsp;&nbsp;Add Voter
  </a>
</div>

<!-- Search & Controls -->
<div class="row g-3 mb-4 align-items-center">
  <div class="col-md-6 col-lg-4">
    <div class="input-group shadow-sm">
      <span class="input-group-text bg-white border-end-0"><i class="fa fa-search"></i></span>
      <input type="text" id="searchVoter" class="form-control border-start-0"
             placeholder="Search by name or email">
    </div>
  </div>
  <div class="col-md-6 col-lg-4 p-2">
    <select id="rowsPerPage" class="form-select shadow-sm p-1 rounded-5">
      <option value="5">5 rows</option>
      <option value="10" selected>10 rows</option>
      <option value="25">25 rows</option>
      <option value="50">50 rows</option>
    </select>
  </div>
  <div class="col-md-6 col-lg-4 ms-auto text-end">
    <div class="dropdown">
      <button class="btn btn-outline-primary dropdown-toggle shadow-sm" type="button"
              id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fa fa-download me-2 text-primary"></i>&nbsp;&nbsp;Export
      </button>
      <ul class="dropdown-menu mt-1">
        <li><a class="dropdown-item" href="#" onclick="exportToPDF()">
          <i class="fa fa-file-pdf-o text-danger me-2"></i>Export to PDF</a></li>
        <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
          <i class="fa fa-file-excel-o text-success me-2"></i>Export to Excel</a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Voter Table -->
<div class="table-responsive rounded shadow-sm">
  <table class="table table-bordered table-hover bg-white align-middle text-nowrap" id="voterTable"
         style="font-size: 0.98rem;">
    <thead class="table text-center align-middle" style="background-color: blue; color: white;">
      <tr>
        <th>SNo.</th>
        <th>Name</th>
        <th>Email</th>
        <th>Password</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody id="voterTableBody">
      <!-- JS will inject rows -->
    </tbody>
  </table>
</div>

<!-- Pagination -->
<nav aria-label="Page navigation" class="position-sticky bottom-0 bg-white mt-4 p-4 py-2 z-3 rounded shadow-sm">
  <ul class="pagination justify-content-center mb-0" id="pagination">
    <!-- JS will inject pagination -->
  </ul>
</nav>

<!-- JS -->
<script>
  let voters = [];
  let filteredVoters = [];
  let currentPage = 1;
  let rowsPerPage = 10;

  async function fetchVoters() {
    try {
      const response = await fetch('/api/voters/');
      if (!response.ok) throw new Error('Failed to fetch voters');
      voters = await response.json();
      filteredVoters = [...voters];
      renderVoterTable();
      renderPagination();
    } catch (err) {
      alert("Error fetching voter data.");
      console.error(err);
    }
  }

  function renderVoterTable() {
    const tbody = document.getElementById("voterTableBody");
    tbody.innerHTML = "";
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = filteredVoters.slice(start, end);

    pageData.forEach((voter, idx) => {
      tbody.innerHTML += `
        <tr>
          <td>${start + idx + 1}</td>
          <td>${voter.name}</td>
          <td>${voter.email}</td>
          <td>${voter.password}</td>
          <td class="text-center">
            <a href="#" class="btn btn-sm btn-primary me-1"><i class="fa fa-pencil"></i></a>
            <a href="#" class="btn btn-sm btn-danger"><i class="fa fa-trash"></i></a>
          </td>
        </tr>`;
    });
  }

  function renderPagination() {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";
    const totalPages = Math.ceil(filteredVoters.length / rowsPerPage);

    const prevClass = currentPage === 1 ? 'disabled' : '';
    const nextClass = currentPage === totalPages ? 'disabled' : '';

    pagination.innerHTML += `<li class="page-item ${prevClass}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;

    for (let i = 1; i <= totalPages; i++) {
      const active = currentPage === i ? "active" : "";
      pagination.innerHTML += `<li class="page-item ${active}">
          <a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }

    pagination.innerHTML += `<li class="page-item ${nextClass}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
  }

  document.getElementById("searchVoter").addEventListener("input", function () {
    const q = this.value.trim().toLowerCase();
    filteredVoters = voters.filter(voter =>
      voter.name.toLowerCase().includes(q) || voter.email.toLowerCase().includes(q)
    );
    currentPage = 1;
    renderVoterTable();
    renderPagination();
  });

  document.getElementById("rowsPerPage").addEventListener("change", function () {
    rowsPerPage = parseInt(this.value, 10);
    currentPage = 1;
    renderVoterTable();
    renderPagination();
  });

  document.getElementById("pagination").addEventListener("click", function (e) {
    if (e.target.tagName === "A") {
      e.preventDefault();
      const page = parseInt(e.target.dataset.page);
      const totalPages = Math.ceil(filteredVoters.length / rowsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderVoterTable();
        renderPagination();
      }
    }
  });

  function exportToPDF() {
    alert("Export to PDF not implemented.");
  }

  function exportToExcel() {
    alert("Export to Excel not implemented.");
  }

  // Load voters on page load
  fetchVoters();
</script>

{% endblock content %}
